name: Compiler Bench

on:
  push:
    branches: ["master", "main"]
  pull_request:
  workflow_dispatch:

jobs:
  compile-and-bench:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Validate package manifest JSON
        shell: bash
        run: |
          set -euo pipefail

          echo "Validating all package.json files..."
          fail=0

          while IFS= read -r -d '' file; do
            if ! node -e "const fs = require('node:fs'); JSON.parse(fs.readFileSync(process.argv[1], 'utf8'))" "$file"; then
              echo "::error file=$file::Invalid JSON in package.json"
              fail=1
            fi
          done < <(find . -name package.json -print0)

          if [ "$fail" -ne 0 ]; then
            echo "One or more package.json files are invalid JSON."
            exit 1
          fi

          echo "All package.json files are valid JSON."

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Compile and benchmark
        shell: bash
        run: |
          set -euo pipefail

          BENCH_DIR="${GITHUB_WORKSPACE}/.bench"
          mkdir -p "$BENCH_DIR"

          clean_outputs() {
            find . -type d -name dist -prune -exec rm -rf {} +
            find . -type f -name '*.tsbuildinfo' -delete
          }

          run_bench() {
            local name="$1"
            local cmd="$2"
            local log_file="${BENCH_DIR}/${name// /_}.log"
            local start_ms end_ms duration_ms duration_s
            local status
            local log_tail=20

            clean_outputs
            start_ms="$(date +%s%3N)"
            set +e
            bash -lc "$cmd" 2>&1 | tee "$log_file"
            local rc="${PIPESTATUS[0]}"
            set -e
            end_ms="$(date +%s%3N)"
            duration_ms="$((end_ms - start_ms))"
            duration_s="$(awk -v ms="$duration_ms" 'BEGIN { printf "%.3f", ms/1000 }')"

            if [ "$rc" -eq 0 ]; then
              status="PASS"
              echo "Compile/bench pass: $name (${duration_s}s)"
              echo "Last ${log_tail} lines for $name:"
              tail -n "$log_tail" "$log_file" || true
            else
              status="FAIL($rc)"
              echo "Compile/bench failed: $name (exit $rc)"
              echo "Full log for $name:"
              cat "$log_file"
            fi

            printf "| %s | %s | %s |\n" "$name" "$status" "$duration_s" >> "$BENCH_DIR/summary.table.md"
            printf "%s|%s|%s|%s\n" "$name" "$status" "$duration_ms" "$cmd" >> "$BENCH_DIR/results.csv"
          }

          echo "| Compiler | Status | Duration (s) |" > "$BENCH_DIR/summary.table.md"
          echo "| --- | --- | ---: |" >> "$BENCH_DIR/summary.table.md"
          echo "compiler,status,duration_ms,command" > "$BENCH_DIR/results.csv"

          run_bench "tsc v5" "npx -y -p typescript@5 tsc -b tsconfig.json --pretty false"
          run_bench "tsc v6 beta" "npx -y -p typescript@beta tsc -b tsconfig.json --pretty false"
          run_bench "tsgo" "npx -y -p @typescript/native-preview tsgo -b tsconfig.json --pretty false"

          {
            echo "## Compiler Benchmark"
            echo
            cat "$BENCH_DIR/summary.table.md"
            echo
            echo "Raw results: \`.bench/results.csv\`"
            echo
            echo "Note: benchmark status may show compiler failures while CI still succeeds to preserve timing/report visibility."
          } >> "$GITHUB_STEP_SUMMARY"

          if [ ! -s "$BENCH_DIR/summary.table.md" ]; then
            {
              echo "| Compiler | Status | Duration (s) |"
              echo "| --- | --- | ---: |"
              echo "| no-run | FAIL | 0.000 |"
            } > "$BENCH_DIR/summary.table.md"
          fi

          if [ ! -s "$BENCH_DIR/results.csv" ]; then
            {
              echo "compiler,status,duration_ms,command"
              echo "no-run,FAIL,0,compile-and-bench"
            } > "$BENCH_DIR/results.csv"
          fi

          if ! find "$BENCH_DIR" -maxdepth 1 -type f -name '*.log' | grep -q .; then
            : > "$BENCH_DIR/no-output.log"
            printf "%s\n" "No compiler output logs were produced." > "$BENCH_DIR/no-output.log"
          fi

      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-bench-${{ github.run_id }}
          if-no-files-found: ignore
          path: |
            ${{ github.workspace }}/.bench/summary.table.md
            ${{ github.workspace }}/.bench/results.csv
            ${{ github.workspace }}/.bench/*.log
